<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria: bikes</title>
    <!-- 
      ####################################################################
      #  TUTAJ JEST KLUCZOWA POPRAWKA:                                   #
      #  Zamiast " ../gallery_styles.css"               #
      #  U≈ºywamy "../gallery_styles.css"              #
      #  css_path_prefix jest przekazywane z gallery_generator.py       #
      #  i jest albo "" (dla roota) albo "../" (dla podfolder√≥w)        #
      ####################################################################
    -->
    <link rel="stylesheet" href="../gallery_styles.css" />
  </head>
  <body>
    <div class="container">
      <!-- TYLKO BREADCRUMB - ≈õcie≈ºka -->
      <div class="breadcrumb">
         
        <a href="../index.html">TRANSPORT</a>
          
        <span>/</span>
          
        <span>bikes</span>
          
      </div>

       
      <div class="section">
        <h2>üñºÔ∏è Pliki z podglƒÖdem (9)</h2>
        <div class="gallery" id="filesWithPreviewsGallery">
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="119449.5402749d5015a.zip"
              data-path="C:\_cloud\TRANSPORT\bikes\119449.5402749d5015a.zip"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/119449.5402749d5015a.jpeg"
              alt="PodglƒÖd dla 119449.5402749d5015a.zip"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/119449.5402749d5015a.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/119449.5402749d5015a.zip" title="Otw√≥rz: 119449.5402749d5015a.zip"
                >119449.5402749d5015a.zip</a
              >
            </p>
            <p class="file-info">73.26 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="2382839.5c81c6cba7dc3.zip"
              data-path="C:\_cloud\TRANSPORT\bikes\2382839.5c81c6cba7dc3.zip"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/2382839.5c81c6cba7dc3.jpeg"
              alt="PodglƒÖd dla 2382839.5c81c6cba7dc3.zip"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/2382839.5c81c6cba7dc3.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/2382839.5c81c6cba7dc3.zip" title="Otw√≥rz: 2382839.5c81c6cba7dc3.zip"
                >2382839.5c81c6cba7dc3.zip</a
              >
            </p>
            <p class="file-info">42.54 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="2634426.5decaca51d2ab.zip"
              data-path="C:\_cloud\TRANSPORT\bikes\2634426.5decaca51d2ab.zip"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/2634426.5decaca51d2ab.jpeg"
              alt="PodglƒÖd dla 2634426.5decaca51d2ab.zip"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/2634426.5decaca51d2ab.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/2634426.5decaca51d2ab.zip" title="Otw√≥rz: 2634426.5decaca51d2ab.zip"
                >2634426.5decaca51d2ab.zip</a
              >
            </p>
            <p class="file-info">40.31 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="3866826.61c203902f128.zip"
              data-path="C:\_cloud\TRANSPORT\bikes\3866826.61c203902f128.zip"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/3866826.61c203902f128.jpeg"
              alt="PodglƒÖd dla 3866826.61c203902f128.zip"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/3866826.61c203902f128.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/3866826.61c203902f128.zip" title="Otw√≥rz: 3866826.61c203902f128.zip"
                >3866826.61c203902f128.zip</a
              >
            </p>
            <p class="file-info">65.37 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="Bicycle storage system.rar"
              data-path="C:\_cloud\TRANSPORT\bikes\Bicycle storage system.rar"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/Bicycle storage system.jpg"
              alt="PodglƒÖd dla Bicycle storage system.rar"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/Bicycle storage system.jpg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/Bicycle storage system.rar" title="Otw√≥rz: Bicycle storage system.rar"
                >Bicycle storage system.rar</a
              >
            </p>
            <p class="file-info">100.15 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="Electra Amsterdam Classic 3i.rar"
              data-path="C:\_cloud\TRANSPORT\bikes\Electra Amsterdam Classic 3i.rar"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/Electra Amsterdam Classic 3i.jpeg"
              alt="PodglƒÖd dla Electra Amsterdam Classic 3i.rar"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/Electra Amsterdam Classic 3i.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/Electra Amsterdam Classic 3i.rar" title="Otw√≥rz: Electra Amsterdam Classic 3i.rar"
                >Electra Amsterdam Classic 3i.rar</a
              >
            </p>
            <p class="file-info">17.31 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="Fuji Classic Track.rar"
              data-path="C:\_cloud\TRANSPORT\bikes\Fuji Classic Track.rar"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/Fuji Classic Track 1.jpeg"
              alt="PodglƒÖd dla Fuji Classic Track.rar"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/Fuji Classic Track 1.jpeg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/Fuji Classic Track.rar" title="Otw√≥rz: Fuji Classic Track.rar"
                >Fuji Classic Track.rar</a
              >
            </p>
            <p class="file-info">7.62 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="Magnum Peak Mountain Bicycle.rar"
              data-path="C:\_cloud\TRANSPORT\bikes\Magnum Peak Mountain Bicycle.rar"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/Magnum Peak Mountain Bicycle 3.jpg"
              alt="PodglƒÖd dla Magnum Peak Mountain Bicycle.rar"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/Magnum Peak Mountain Bicycle 3.jpg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/Magnum Peak Mountain Bicycle.rar" title="Otw√≥rz: Magnum Peak Mountain Bicycle.rar"
                >Magnum Peak Mountain Bicycle.rar</a
              >
            </p>
            <p class="file-info">13.10 MB</p>
          </div>
          
          <div
            class="gallery-item"
            style="background-color: #6c757d22; border-color: #6c757d;"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="TR_500.rar"
              data-path="C:\_cloud\TRANSPORT\bikes\TR_500.rar"
              data-type="archive"
            />
            
            <img
              src="file:///C:/_cloud/TRANSPORT/bikes/TR_500.jpg"
              alt="PodglƒÖd dla TR_500.rar"
              class="preview-image"
              data-full-src="file:///C:/_cloud/TRANSPORT/bikes/TR_500.jpg"
              loading="lazy"
            />
            
            <p>
              <a href="file:///C:/_cloud/TRANSPORT/bikes/TR_500.rar" title="Otw√≥rz: TR_500.rar"
                >TR_500.rar</a
              >
            </p>
            <p class="file-info">99.97 MB</p>
          </div>
          
        </div>
      </div>
        
    </div>

    <div class="preview-backdrop" id="previewBackdrop"></div>
    <div class="preview-modal" id="previewModal">
      <img src="" alt="PodglƒÖd" id="previewImg" />
    </div>

    <script>
      // Przekazanie danych z Pythona do JS dla wiƒôkszej niezawodno≈õci
      // Upewnij siƒô, ≈ºe `folder_info` zawiera `path_absolute`
      window.galleryConfig = {
          currentFolderAbsPath: "null",
          isRootIndex: false,
          scannedRootPath: "C:\\_cloud\\TRANSPORT"
      };

      console.log("Gallery Config from Python:", window.galleryConfig);

      function getCurrentFolder() {
        if (window.galleryConfig && window.galleryConfig.currentFolderAbsPath) {
            return window.galleryConfig.currentFolderAbsPath.replace(/\\/g, '/');
        }
        console.warn("getCurrentFolder: Fallback, window.galleryConfig.currentFolderAbsPath not available.");
        return ".";
      }
      window.getCurrentFolder = getCurrentFolder;

      document.addEventListener('DOMContentLoaded', function () {
        console.log('=== ROZPOCZYNAM INICJALIZACJƒò GALERII ===');

        const galleries = [
          document.getElementById('filesWithPreviewsGallery'),
        ].filter(Boolean);

        const previewModal = document.getElementById('previewModal');
        const previewBackdrop = document.getElementById('previewBackdrop');
        const previewImg = document.getElementById('previewImg');
        const matchBtn = document.getElementById('matchPreviewBtn');
        const matchStatus = document.getElementById('matchStatus');

        // Sprawd≈∫ czy wszystkie potrzebne elementy sƒÖ dostƒôpne
        if (!previewModal || !previewBackdrop || !previewImg) {
          console.error('Brak wymaganych element√≥w modalu podglƒÖdu:', {
            previewModal: !!previewModal,
            previewBackdrop: !!previewBackdrop,
            previewImg: !!previewImg
          });
        }

        console.log('Elementy galerii:', {
          galleries: galleries.length,
          previewModal: !!previewModal,
          previewBackdrop: !!previewBackdrop,
          previewImg: !!previewImg,
          matchBtn: !!matchBtn
        });

        function showPreview(imageSrc) {
          console.log('showPreview wywo≈Çane z:', imageSrc);

          if (!imageSrc) {
            console.error('Brak ≈∫r√≥d≈Ça obrazu');
            return;
          }

          if (!previewModal || !previewBackdrop || !previewImg) {
            console.error('Brak element√≥w modal');
            return;
          }

          // Najpierw pokazujemy backdrop
          previewBackdrop.style.display = 'block';
          previewModal.style.display = 'block';

          // Dajemy czas na wyrenderowanie
          requestAnimationFrame(() => {
            previewBackdrop.classList.add('show');
            previewModal.classList.add('show');
          });

          // Ustaw ≈∫r√≥d≈Ço obrazu
          previewImg.src = imageSrc;
        }

        function hidePreview() {
          if (!previewModal || !previewBackdrop || !previewImg) return;

          previewModal.classList.remove('show');
          previewBackdrop.classList.remove('show');

          setTimeout(() => {
            previewModal.style.display = 'none';
            previewBackdrop.style.display = 'none';
            previewImg.src = '';
          }, 200);
        }

        const deleteButtons = document.querySelectorAll('.delete-image-btn');
        deleteButtons.forEach((button) => {
          button.addEventListener('click', function (e) {
            e.preventDefault(); e.stopPropagation();
            const filePath = this.dataset.filePath;
            const fileName = this.dataset.fileName;
            if (confirm(`Czy na pewno chcesz usunƒÖƒá plik "${fileName}" do kosza?`)) {
              try {
                if (typeof Storage === 'undefined' || !localStorage) { alert('Funkcja usuwania nie jest dostƒôpna.'); return; }
                const deleteData = { action: 'deleteFile', filePath: filePath, fileName: fileName, timestamp: new Date().toISOString() };
                console.log('üóëÔ∏è Usuwanie pliku:', deleteData);
                const deleteKey = 'deleteFile_' + Date.now();
                localStorage.setItem(deleteKey, JSON.stringify(deleteData));
                localStorage.setItem('latestDelete', deleteKey);
                this.textContent = '‚è≥'; this.disabled = true; this.style.opacity = '0.5';
                const statusDiv = document.createElement('div');
                statusDiv.className = 'file-operation-notification warning';
                statusDiv.textContent = `‚è≥ Usuwanie "${fileName}"...`;
                document.body.appendChild(statusDiv);
                setTimeout(() => { if (statusDiv.parentNode) statusDiv.parentNode.removeChild(statusDiv); }, 5000);
              } catch (err) { console.error('B≈ÇƒÖd usuwania pliku:', err); alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania.'); }
            }
          });
        });

        galleries.forEach((gallery) => {
          if (!gallery) return;

          const images = gallery.querySelectorAll('.preview-image');
          console.log(`Znaleziono ${images.length} obraz√≥w podglƒÖdu w galerii`);

          images.forEach((img) => {
            let hoverTimeout;

            img.addEventListener('mouseenter', function() {
              const imageSrc = this.dataset.fullSrc || this.src;
              console.log('MOUSEENTER na obrazie:', imageSrc);

              hoverTimeout = setTimeout(() => {
                showPreview(imageSrc);
              }, 2000);
            });

            img.addEventListener('mouseleave', function() {
              clearTimeout(hoverTimeout);
              hidePreview();
            });
          });
        });

        const previewLinks = document.querySelectorAll('.preview-link');
        console.log(`Znaleziono ${previewLinks.length} link√≥w z podglƒÖdem`);

        previewLinks.forEach((link) => {
          let hoverTimeout;

          link.addEventListener('mouseenter', function() {
            const previewSrc = this.getAttribute('data-preview-src');
            console.log('MOUSEENTER na linku:', previewSrc);

            if (previewSrc) {
              hoverTimeout = setTimeout(() => {
                showPreview(previewSrc);
              }, 2000);
            }
          });

          link.addEventListener('mouseleave', function() {
            clearTimeout(hoverTimeout);
            hidePreview();
          });
        });

        previewBackdrop.addEventListener('click', hidePreview);
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            hidePreview();
          }
        });

        if (matchBtn) {
          console.log('=== INICJALIZUJƒò FUNKCJƒò DOPASOWANIA ===');

          let localStorageAvailable = false;
          try {
              if (typeof Storage !== 'undefined' && localStorage) {
                  localStorage.setItem('test','test');
                  localStorage.removeItem('test');
                  localStorageAvailable = true;
                  console.log('localStorage jest dostƒôpny');
              }
          } catch (e) {
              console.warn('localStorage nie jest dostƒôpny:', e);
          }

          if (!localStorageAvailable) {
              matchBtn.style.display = 'none';
              if(matchStatus) matchStatus.textContent = '‚ö†Ô∏è Funkcje uczenia niedostƒôpne.';
              return;
          }

          // POPRAWIONY SELEKTOR - wszystkie checkboxy
          const checkboxes = document.querySelectorAll('input[type="checkbox"]');
          console.log('=== CHECKBOXY ===');
          console.log('Wszystkich checkbox√≥w:', checkboxes.length);

          // Debugowanie ka≈ºdego checkboxa
          checkboxes.forEach((cb, i) => {
            console.log(`Checkbox ${i}:`, {
              file: cb.dataset.file,
              type: cb.dataset.type,
              hasGalleryClass: cb.classList.contains('gallery-checkbox'),
              hasFileClass: cb.classList.contains('file-checkbox')
            });
          });

          function updateMatchButton() {
              console.log('=== AKTUALIZUJƒò STAN PRZYCISKU ===');

              const archiveChecked = [];
              const imageChecked = [];

              checkboxes.forEach((cb) => {
                  if (cb.checked) {
                      const isArchive = cb.dataset.type === 'archive' || cb.classList.contains('gallery-checkbox');
                      const isImage = cb.dataset.type === 'image';

                      console.log(`Zaznaczony checkbox ${cb.dataset.file}:`, {
                        type: cb.dataset.type,
                        isArchive,
                        isImage,
                        hasGalleryClass: cb.classList.contains('gallery-checkbox')
                      });

                      if (isArchive) {
                          archiveChecked.push(cb);
                      } else if (isImage) {
                          imageChecked.push(cb);
                      }
                  }
              });

              console.log('Archiw√≥w zaznaczonych:', archiveChecked.length);
              console.log('Obraz√≥w zaznaczonych:', imageChecked.length);

              const canMatch = archiveChecked.length === 1 && imageChecked.length === 1;
              matchBtn.disabled = !canMatch;

              if (matchStatus) {
                  if (canMatch) {
                      const archiveName = archiveChecked[0].dataset.file;
                      const imageName = imageChecked[0].dataset.file;
                      matchStatus.textContent = `Gotowy: ${archiveName} ‚Üî ${imageName}`;
                      console.log('PRZYCISK AKTYWNY - gotowy do dopasowania');
                  } else if (archiveChecked.length === 0 && imageChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 archiwum i 1 obraz';
                  } else if (archiveChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 archiwum';
                  } else if (imageChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 obraz';
                  } else {
                      matchStatus.textContent = 'Zaznacz tylko 1 archiwum i 1 obraz';
                  }
              }
          }

          // DODAJ LISTENERY DO WSZYSTKICH CHECKBOX√ìW
          checkboxes.forEach((checkbox, index) => {
              console.log(`Dodajƒô listener do checkboxa ${index}:`, checkbox.dataset.file);

              checkbox.addEventListener('change', function () {
                  console.log(`=== CHECKBOX ZMIENIONY ===`);
                  console.log('Plik:', this.dataset.file);
                  console.log('Nowy stan:', this.checked);
                  console.log('Typ:', this.dataset.type);

                  if (this.checked) {
                      const currentType = this.dataset.type || (this.classList.contains('gallery-checkbox') ? 'archive' : 'unknown');
                      console.log('Typ bie≈ºƒÖcego checkboxa:', currentType);

                      // Odznacz inne checkboxy tego samego typu
                      checkboxes.forEach((otherCb) => {
                          if (otherCb !== this) {
                              const otherType = otherCb.dataset.type || (otherCb.classList.contains('gallery-checkbox') ? 'archive' : 'unknown');
                              if (otherType === currentType && otherCb.checked) {
                                  console.log(`Odznaczam ${otherCb.dataset.file} (ten sam typ)`);
                                  otherCb.checked = false;
                              }
                          }
                      });
                  }
                  updateMatchButton();
              });
          });

          matchBtn.addEventListener('click', function () {
              const archiveCb = Array.from(checkboxes).find(cb => {
                  return cb.checked && (cb.dataset.type === 'archive' || cb.classList.contains('gallery-checkbox'));
              });
              const imageCb = Array.from(checkboxes).find(cb => {
                  return cb.checked && cb.dataset.type === 'image';
              });

              if (archiveCb && imageCb) {
                  // Pobierz basename z nazwy pliku
                  const getBasename = (filename) => {
                      const lastDotIndex = filename.lastIndexOf('.');
                      return lastDotIndex > 0 ? filename.substring(0, lastDotIndex) : filename;
                  };

                  const matchData = {
                      archiveFile: archiveCb.dataset.file,
                      archivePath: archiveCb.dataset.path.replace(/\\/g, '/'),
                      imageFile: imageCb.dataset.file,
                      imagePath: imageCb.dataset.path.replace(/\\/g, '/'),
                      archiveBasename: getBasename(archiveCb.dataset.file),
                      imageBasename: getBasename(imageCb.dataset.file),
                      timestamp: new Date().toISOString(),
                      currentFolder: getCurrentFolder()
                  };

                  console.log('üéØ Zapisujƒô dopasowanie:', matchData);

                  const matchKey = 'learningMatch_' + Date.now();
                  localStorage.setItem(matchKey, JSON.stringify(matchData));
                  localStorage.setItem('latestLearningMatch', matchKey);

                  if(matchStatus) matchStatus.textContent = '‚úÖ Zapisano! Nauka algorytmu...';
                  matchBtn.disabled = true;
                  matchBtn.textContent = '‚è≥ Przetwarzanie...';

                  // Odznacz checkboxy
                  archiveCb.checked = false;
                  imageCb.checked = false;

                  // Przywr√≥ƒá stan przycisku po 3 sekundach
                  setTimeout(() => {
                      matchBtn.disabled = false;
                      matchBtn.textContent = 'üéØ Dopasuj podglƒÖd';
                      if(matchStatus) matchStatus.textContent = '';
                  }, 3000);
              }
          });

          // Inicjalne sprawdzenie
          updateMatchButton();
        }

        // Logika dla przywracania rozmiaru kafelk√≥w z localStorage (je≈õli suwak jest w Pythonie)
        // Mo≈ºesz jƒÖ usunƒÖƒá, je≈õli rozmiar kafelk√≥w jest zarzƒÖdzany tylko przez suwak w UI Pythona
        if (typeof localStorage !== 'undefined' && localStorage.getItem('galleryTileSize')) {
            const savedSize = localStorage.getItem('galleryTileSize');
            const galleriesToResize = document.querySelectorAll('.gallery');
            galleriesToResize.forEach(gallery => {
                gallery.style.gridTemplateColumns = `repeat(auto-fill, minmax(${savedSize}px, 1fr))`;
            });
        }

        // Poni≈ºsze funkcje (showMoveFilesDialog itp.) sƒÖ definicjami,
        // ale nie sƒÖ wywo≈Çywane bezpo≈õrednio z HTML.
        // SƒÖ one dostƒôpne dla Pythona do wywo≈Çania poprzez webView.page().runJavaScript("showMoveFilesDialog();")
        // je≈õli przyciski by≈Çyby w HTML. W Twoim przypadku przyciski sƒÖ w Pythonie,
        // wiƒôc ta czƒô≈õƒá jest bardziej "bibliotekƒÖ" funkcji dla localStorage.

        let selectedFiles = []; // Zmienna globalna w tym zakresie DOMContentLoaded

        function updateSelectedFiles() {
          selectedFiles = [];
          document.querySelectorAll('.gallery-checkbox:checked').forEach(cb => {
            selectedFiles.push({ type: 'archive_with_preview', name: cb.dataset.file, path: cb.dataset.path, preview: cb.closest('.gallery-item').querySelector('img')?.src || null });
          });
          document.querySelectorAll('.file-checkbox:checked[data-type="archive"]').forEach(cb => {
            selectedFiles.push({ type: 'archive', name: cb.dataset.file, path: cb.dataset.path, basename: cb.dataset.basename });
          });
          document.querySelectorAll('.file-checkbox:checked[data-type="image"]').forEach(cb => {
            selectedFiles.push({ type: 'image', name: cb.dataset.file, path: cb.dataset.path, basename: cb.dataset.basename });
          });
          console.log('JS: Wybrane pliki:', selectedFiles);
        }

        // Te funkcje zapisujƒÖ dane do localStorage, Python je odczytuje
        window.jsShowMoveFilesDialog = function() { // Zmieniono nazwƒô, aby uniknƒÖƒá konfliktu
          updateSelectedFiles();
          if (selectedFiles.length === 0) { alert('Najpierw zaznacz pliki do przeniesienia'); return; }
          const moveData = { files: selectedFiles };
          const moveKey = 'moveFiles_' + Date.now();
          localStorage.setItem(moveKey, JSON.stringify(moveData));
          localStorage.setItem('latestMoveFiles', moveKey);
          document.querySelectorAll('.gallery-checkbox, .file-checkbox').forEach(cb => { cb.checked = false; });
          console.log('JS: Zapisano operacjƒô przenoszenia:', moveData);
        }

        window.jsShowRenameFilesDialog = function() { // Zmieniono nazwƒô
          updateSelectedFiles();
          if (selectedFiles.length === 0) { alert('Najpierw zaznacz pliki do zmiany nazwy'); return; }
          const archiveFiles = selectedFiles.filter(f => f.type === 'archive' || f.type === 'archive_with_preview');
          const imageFiles = selectedFiles.filter(f => f.type === 'image');
          // Zamiast prompt, Python zapyta o nowƒÖ nazwƒô
          // Tutaj tylko przygotowujemy dane
          if (archiveFiles.length > 0 || imageFiles.length > 0) { // Wystarczy, ≈ºe co≈õ jest zaznaczone
              const renameData = { files: selectedFiles, /* newBaseName zostanie dodane przez Pythona */ };
              const renameKey = 'renameFiles_' + Date.now();
              localStorage.setItem(renameKey, JSON.stringify(renameData));
              localStorage.setItem('latestRenameFilesRequest', renameKey); // Inny klucz dla ≈ºƒÖdania
              document.querySelectorAll('.gallery-checkbox, .file-checkbox').forEach(cb => { cb.checked = false; });
              console.log('JS: Zapisano ≈ºƒÖdanie zmiany nazw:', renameData);
          } else {
            alert('Zaznacz pliki, aby zmieniƒá ich nazwy.');
          }
        }

        window.jsShowCreateFolderDialog = function() { // Zmieniono nazwƒô
          const folderName = prompt('Podaj nazwƒô nowego folderu:'); // JS mo≈ºe zapytaƒá, albo Python
          if (folderName && folder_name.trim()) { // U≈ºyj folder_name z prompt
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(folder_name.trim())) {
              alert(`Nazwa folderu zawiera niedozwolone znaki: ${invalidChars.source}`); return;
            }
            const createData = { parentFolder: getCurrentFolder(), folderName: folder_name.trim() };
            const createKey = 'createFolder_' + Date.now();
            localStorage.setItem(createKey, JSON.stringify(createData));
            localStorage.setItem('latestCreateFolder', createKey);
            console.log('JS: Zapisano operacjƒô tworzenia folderu:', createData);
          }
        }

        // Listener dla checkbox√≥w, aby aktualizowaƒá `selectedFiles`
        document.addEventListener('change', function (e) {
          if (e.target.matches('.gallery-checkbox, .file-checkbox')) {
            updateSelectedFiles(); // Aktualizuj przy ka≈ºdej zmianie zaznaczenia
          }
        });

      });
    </script>
  </body>
</html>