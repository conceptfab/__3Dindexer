<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria: {{ current_folder_display_name }}</title>
    <!-- 
      ####################################################################
      #  TUTAJ JEST KLUCZOWA POPRAWKA:                                   #
      #  Zamiast "{{ ' ../' * depth }}gallery_styles.css"               #
      #  U≈ºywamy "{{ css_path_prefix }}gallery_styles.css"              #
      #  css_path_prefix jest przekazywane z gallery_generator.py       #
      #  i jest albo "" (dla roota) albo "../" (dla podfolder√≥w)        #
      ####################################################################
    -->
    <link rel="stylesheet" href="{{ css_path_prefix }}gallery_styles.css" />
  </head>
  <body>
    <div class="container">
      <!-- TYLKO BREADCRUMB - ≈õcie≈ºka -->
      <div class="breadcrumb">
        {% for part in breadcrumb_parts %} {% if part.link %}
        <a href="{{ part.link }}">{{ part.name }}</a>
        {% else %}
        <span>{{ part.name }}</span>
        {% endif %} {% if not loop.last %} {# Dodaj separator, je≈õli to nie
        ostatni element #}
        <span>/</span>
        {% endif %} {% endfor %}
      </div>

      {% if subfolders %}
      <div class="section">
        <h2>üìÅ Podfoldery ({{ subfolders|length }})</h2>
        <div class="subfolders-grid">
          {% for sf in subfolders %}
          <div
            class="subfolder-item"
            onclick="window.location.href='{{ sf.link }}'"
          >
            <div class="folder-icon" data-archive-count="{{ sf.file_count }}">
              üìÅ
            </div>
            <a href="{{ sf.link }}">{{ sf.name }}</a>
            <div class="folder-stats">
              <span
                >{{ sf.total_size_readable }} | {{ sf.file_count }} plik√≥w{% if
                sf.subdir_count > 0 %} | {{ sf.subdir_count }} folder√≥w{% endif
                %}</span
              >
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% elif not files_with_previews and not other_images and not
      is_root_gallery_index %} {# Je≈õli nie ma podfolder√≥w, plik√≥w z podglƒÖdem,
      innych obraz√≥w, i nie jeste≈õmy w roocie, to znaczy, ≈ºe jeste≈õmy w li≈õciu
      drzewa, kt√≥ry jest pusty - mo≈ºna to obs≈Çu≈ºyƒá inaczej, ale je≈õli taki
      folder ma index.json to powinien wy≈õwietliƒá co≈õ. Je≈õli nie ma subfolder√≥w,
      a jeste≈õmy w roocie, to JS/Python mo≈ºe chcieƒá wy≈õwietliƒá info. Ten warunek
      jest trochƒô skomplikowany - mo≈ºe pro≈õciej wy≈õwietliƒá poni≈ºsze je≈õli nic
      innego nie ma. #} {% endif %} {% if files_with_previews %}
      <div class="section">
        <h2>üñºÔ∏è Pliki z podglƒÖdem ({{ files_with_previews|length }})</h2>
        <div class="gallery" id="filesWithPreviewsGallery">
          {% for file in files_with_previews %}
          <div
            class="gallery-item"
            style="background-color: {{ file.archive_color if file.archive_color else 'transparent' }}22; border-color: {{ file.archive_color if file.archive_color else 'var(--border)' }};"
          >
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="{{ file.name }}"
              data-path="{{ file.path_absolute }}"
              data-type="archive_with_preview"
              data-archive-name="{{ file.name }}"
              data-archive-path="{{ file.path_absolute }}"
              data-preview-name="{{ file.preview_name if file.preview_name else '' }}"
              data-preview-path="{{ file.preview_path_absolute if file.preview_path_absolute else '' }}"
            />
            {% if file.preview_relative_path %}
            <img
              src="{{ file.preview_relative_path }}"
              alt="PodglƒÖd dla {{ file.name }}"
              class="preview-image"
              data-full-src="{{ file.preview_relative_path }}"
              loading="lazy"
            />
            {% else %}
            <div
              style="
                height: 160px;
                background: var(--bg-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: var(--radius-sm);
                color: var(--text-secondary);
              "
            >
              <span>Brak podglƒÖdu</span>
            </div>
            {% endif %}
            <p>
              <a href="{{ file.archive_link }}" title="Otw√≥rz: {{ file.name }}"
                >{{ file.name }}</a
              >
            </p>
            <p class="file-info">{{ file.size_readable }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %} {% if files_without_previews or other_images %}
      <div class="bottom-columns">
        {% if files_without_previews %}
        <div class="left-column">
          <h2>üìÑ Pliki bez podglƒÖdu ({{ files_without_previews|length }})</h2>
          {% if files_without_previews %}
          <ul class="no-preview-list">
            {% for file in files_without_previews %}
            <li
              style="border-left: 4px solid {{ file.archive_color if file.archive_color else 'transparent' }};"
            >
              <div class="file-item">
                <input
                  type="checkbox"
                  class="file-checkbox"
                  data-file="{{ file.name }}"
                  data-path="{{ file.path_absolute }}"
                  data-basename="{{ file.name.split('.')[0] if '.' in file.name else file.name }}"
                  data-type="archive"
                  data-archive-name="{{ file.name }}"
                  data-archive-path="{{ file.path_absolute }}"
                />
                <a
                  href="{{ file.archive_link }}"
                  title="Otw√≥rz: {{ file.name }}"
                  >{{ file.name }}</a
                >
                <span class="file-info"> ‚Äî {{ file.size_readable }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p>Brak plik√≥w bez podglƒÖdu.</p>
          {% endif %}
        </div>
        {% endif %} {% if other_images %}
        <div class="right-column">
          <h2>üé® Pozosta≈Çe obrazy ({{ other_images|length }})</h2>
          {% if other_images %}
          <ul class="image-list">
            {% for image in other_images %}
            <li>
              <div class="file-item">
                <input
                  type="checkbox"
                  class="file-checkbox"
                  data-file="{{ image.name }}"
                  data-path="{{ image.path_absolute }}"
                  data-basename="{{ image.name.split('.')[0] if '.' in image.name else image.name }}"
                  data-type="image"
                  data-preview-name="{{ image.name }}"
                  data-preview-path="{{ image.path_absolute }}"
                />
                <a
                  href="{{ image.file_link }}"
                  title="Otw√≥rz: {{ image.name }}"
                  data-preview-src="{{ image.image_relative_path }}"
                  class="preview-link"
                  data-type="image"
                  data-name="{{ image.name }}"
                  >{{ image.name }}</a
                >
                <span class="file-info"> ‚Äî {{ image.size_readable }}</span>
                <button
                  class="delete-image-btn"
                  data-file-path="{{ image.path_absolute }}"
                  data-file-name="{{ image.name }}"
                  title="Usu≈Ñ {{ image.name }} do kosza"
                >
                  üóëÔ∏è
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p>Brak innych obraz√≥w.</p>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% elif not subfolders and not files_with_previews and not
      files_without_previews and not other_images %}
      <div class="section">
        <p>
          Ten folder jest pusty lub nie zawiera element√≥w do wy≈õwietlenia w
          galerii.
        </p>
      </div>
      {% endif %} {% if (files_without_previews and other_images) or
      (files_with_previews and other_images) or (files_with_previews and
      files_without_previews) %}
      <div class="learning-section">
        <button id="matchPreviewBtn" class="match-preview-btn" disabled>
          üéØ Dopasuj podglƒÖd
        </button>
        <div id="matchStatus" class="match-status"></div>
      </div>
      {% endif %}
    </div>

    <div class="preview-backdrop" id="previewBackdrop"></div>
    <div class="preview-modal" id="previewModal">
      <img src="" alt="PodglƒÖd" id="previewImg" />
    </div>

    <script>
      // Przekazanie danych z Pythona do JS dla wiƒôkszej niezawodno≈õci
      // Upewnij siƒô, ≈ºe `folder_info` zawiera `path_absolute`
      window.galleryConfig = {
          currentFolderAbsPath: "{{ folder_info.path_absolute|tojson|safe if folder_info and folder_info.path_absolute else 'null' }}",
          isRootIndex: {{ is_root_gallery_index|tojson|safe }},
          scannedRootPath: {{ scanned_root_path_abs_for_template|tojson|safe }}
      };

      console.log("Gallery Config from Python:", window.galleryConfig);

      function getCurrentFolder() {
        if (window.galleryConfig && window.galleryConfig.currentFolderAbsPath) {
            return window.galleryConfig.currentFolderAbsPath.replace(/\\/g, '/');
        }
        console.warn("getCurrentFolder: Fallback, window.galleryConfig.currentFolderAbsPath not available.");
        return ".";
      }
      window.getCurrentFolder = getCurrentFolder;

      document.addEventListener('DOMContentLoaded', function () {
        console.log('=== ROZPOCZYNAM INICJALIZACJƒò GALERII ===');

        const galleries = [
          document.getElementById('filesWithPreviewsGallery'),
        ].filter(Boolean);

        const previewModal = document.getElementById('previewModal');
        const previewBackdrop = document.getElementById('previewBackdrop');
        const previewImg = document.getElementById('previewImg');
        const matchBtn = document.getElementById('matchPreviewBtn');
        const matchStatus = document.getElementById('matchStatus');

        // Sprawd≈∫ czy wszystkie potrzebne elementy sƒÖ dostƒôpne
        if (!previewModal || !previewBackdrop || !previewImg) {
          console.error('Brak wymaganych element√≥w modalu podglƒÖdu:', {
            previewModal: !!previewModal,
            previewBackdrop: !!previewBackdrop,
            previewImg: !!previewImg
          });
        }

        console.log('Elementy galerii:', {
          galleries: galleries.length,
          previewModal: !!previewModal,
          previewBackdrop: !!previewBackdrop,
          previewImg: !!previewImg,
          matchBtn: !!matchBtn
        });

        function showPreview(imageSrc) {
          console.log('showPreview wywo≈Çane z:', imageSrc);

          if (!imageSrc) {
            console.error('Brak ≈∫r√≥d≈Ça obrazu');
            return;
          }

          if (!previewModal || !previewBackdrop || !previewImg) {
            console.error('Brak element√≥w modal');
            return;
          }

          // Najpierw pokazujemy backdrop
          previewBackdrop.style.display = 'block';
          previewModal.style.display = 'block';

          // Dajemy czas na wyrenderowanie
          requestAnimationFrame(() => {
            previewBackdrop.classList.add('show');
            previewModal.classList.add('show');
          });

          // Ustaw ≈∫r√≥d≈Ço obrazu
          previewImg.src = imageSrc;
        }

        function hidePreview() {
          if (!previewModal || !previewBackdrop || !previewImg) return;

          previewModal.classList.remove('show');
          previewBackdrop.classList.remove('show');

          setTimeout(() => {
            previewModal.style.display = 'none';
            previewBackdrop.style.display = 'none';
            previewImg.src = '';
          }, 200);
        }

        const deleteButtons = document.querySelectorAll('.delete-image-btn');
        deleteButtons.forEach((button) => {
          button.addEventListener('click', function (e) {
            e.preventDefault(); e.stopPropagation();
            const filePath = this.dataset.filePath;
            const fileName = this.dataset.fileName;
            if (confirm(`Czy na pewno chcesz usunƒÖƒá plik "${fileName}" do kosza?`)) {
              try {
                if (typeof Storage === 'undefined' || !localStorage) { alert('Funkcja usuwania nie jest dostƒôpna.'); return; }
                const deleteData = { action: 'deleteFile', filePath: filePath, fileName: fileName, timestamp: new Date().toISOString() };
                console.log('üóëÔ∏è Usuwanie pliku:', deleteData);
                const deleteKey = 'deleteFile_' + Date.now();
                localStorage.setItem(deleteKey, JSON.stringify(deleteData));
                localStorage.setItem('latestDelete', deleteKey);
                this.textContent = '‚è≥'; this.disabled = true; this.style.opacity = '0.5';
                const statusDiv = document.createElement('div');
                statusDiv.className = 'file-operation-notification warning';
                statusDiv.textContent = `‚è≥ Usuwanie "${fileName}"...`;
                document.body.appendChild(statusDiv);
                setTimeout(() => { if (statusDiv.parentNode) statusDiv.parentNode.removeChild(statusDiv); }, 5000);
              } catch (err) { console.error('B≈ÇƒÖd usuwania pliku:', err); alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania.'); }
            }
          });
        });

        galleries.forEach((gallery) => {
          if (!gallery) return;

          const images = gallery.querySelectorAll('.preview-image');
          console.log(`Znaleziono ${images.length} obraz√≥w podglƒÖdu w galerii`);

          images.forEach((img) => {
            let hoverTimeout;

            img.addEventListener('mouseenter', function() {
              const imageSrc = this.dataset.fullSrc || this.src;
              console.log('MOUSEENTER na obrazie:', imageSrc);

              hoverTimeout = setTimeout(() => {
                showPreview(imageSrc);
              }, 2000);
            });

            img.addEventListener('mouseleave', function() {
              clearTimeout(hoverTimeout);
              hidePreview();
            });
          });
        });

        const previewLinks = document.querySelectorAll('.preview-link');
        console.log(`Znaleziono ${previewLinks.length} link√≥w z podglƒÖdem`);

        previewLinks.forEach((link) => {
          let hoverTimeout;

          link.addEventListener('mouseenter', function() {
            const previewSrc = this.getAttribute('data-preview-src');
            console.log('MOUSEENTER na linku:', previewSrc);

            if (previewSrc) {
              hoverTimeout = setTimeout(() => {
                showPreview(previewSrc);
              }, 2000);
            }
          });

          link.addEventListener('mouseleave', function() {
            clearTimeout(hoverTimeout);
            hidePreview();
          });
        });

        previewBackdrop.addEventListener('click', hidePreview);
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            hidePreview();
          }
        });

        if (matchBtn) {
          console.log('=== INICJALIZUJƒò FUNKCJƒò DOPASOWANIA ===');

          let localStorageAvailable = false;
          try {
              if (typeof Storage !== 'undefined' && localStorage) {
                  localStorage.setItem('test','test');
                  localStorage.removeItem('test');
                  localStorageAvailable = true;
                  console.log('localStorage jest dostƒôpny');
              }
          } catch (e) {
              console.warn('localStorage nie jest dostƒôpny:', e);
          }

          if (!localStorageAvailable) {
              matchBtn.style.display = 'none';
              if(matchStatus) matchStatus.textContent = '‚ö†Ô∏è Funkcje uczenia niedostƒôpne.';
              return;
          }

          // POPRAWIONY SELEKTOR - wszystkie checkboxy
          const checkboxes = document.querySelectorAll('input[type="checkbox"]');
          console.log('=== CHECKBOXY ===');
          console.log('Wszystkich checkbox√≥w:', checkboxes.length);

          // Debugowanie ka≈ºdego checkboxa
          checkboxes.forEach((cb, i) => {
            console.log(`Checkbox ${i}:`, {
              file: cb.dataset.file,
              type: cb.dataset.type,
              hasGalleryClass: cb.classList.contains('gallery-checkbox'),
              hasFileClass: cb.classList.contains('file-checkbox')
            });
          });

          function updateMatchButton() {
              console.log('=== AKTUALIZUJƒò STAN PRZYCISKU ===');

              const archiveChecked = [];
              const imageChecked = [];

              checkboxes.forEach((cb) => {
                  if (cb.checked) {
                      const isArchive = cb.dataset.type === 'archive' || cb.classList.contains('gallery-checkbox');
                      const isImage = cb.dataset.type === 'image';

                      console.log(`Zaznaczony checkbox ${cb.dataset.file}:`, {
                        type: cb.dataset.type,
                        isArchive,
                        isImage,
                        hasGalleryClass: cb.classList.contains('gallery-checkbox')
                      });

                      if (isArchive) {
                          archiveChecked.push(cb);
                      } else if (isImage) {
                          imageChecked.push(cb);
                      }
                  }
              });

              console.log('Archiw√≥w zaznaczonych:', archiveChecked.length);
              console.log('Obraz√≥w zaznaczonych:', imageChecked.length);

              const canMatch = archiveChecked.length === 1 && imageChecked.length === 1;
              matchBtn.disabled = !canMatch;

              if (matchStatus) {
                  if (canMatch) {
                      const archiveName = archiveChecked[0].dataset.file;
                      const imageName = imageChecked[0].dataset.file;
                      matchStatus.textContent = `Gotowy: ${archiveName} ‚Üî ${imageName}`;
                      console.log('PRZYCISK AKTYWNY - gotowy do dopasowania');
                  } else if (archiveChecked.length === 0 && imageChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 archiwum i 1 obraz';
                  } else if (archiveChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 archiwum';
                  } else if (imageChecked.length === 0) {
                      matchStatus.textContent = 'Zaznacz 1 obraz';
                  } else {
                      matchStatus.textContent = 'Zaznacz tylko 1 archiwum i 1 obraz';
                  }
              }
          }

          // DODAJ LISTENERY DO WSZYSTKICH CHECKBOX√ìW
          checkboxes.forEach((checkbox, index) => {
              console.log(`Dodajƒô listener do checkboxa ${index}:`, checkbox.dataset.file);

              checkbox.addEventListener('change', function () {
                  console.log(`=== CHECKBOX ZMIENIONY ===`);
                  console.log('Plik:', this.dataset.file);
                  console.log('Nowy stan:', this.checked);
                  console.log('Typ:', this.dataset.type);

                  if (this.checked) {
                      const currentType = this.dataset.type || (this.classList.contains('gallery-checkbox') ? 'archive' : 'unknown');
                      console.log('Typ bie≈ºƒÖcego checkboxa:', currentType);

                      // Odznacz inne checkboxy tego samego typu
                      checkboxes.forEach((otherCb) => {
                          if (otherCb !== this) {
                              const otherType = otherCb.dataset.type || (otherCb.classList.contains('gallery-checkbox') ? 'archive' : 'unknown');
                              if (otherType === currentType && otherCb.checked) {
                                  console.log(`Odznaczam ${otherCb.dataset.file} (ten sam typ)`);
                                  otherCb.checked = false;
                              }
                          }
                      });
                  }
                  updateMatchButton();
              });
          });

          matchBtn.addEventListener('click', function () {
              const archiveCb = Array.from(checkboxes).find(cb => {
                  return cb.checked && (cb.dataset.type === 'archive' || cb.classList.contains('gallery-checkbox'));
              });
              const imageCb = Array.from(checkboxes).find(cb => {
                  return cb.checked && cb.dataset.type === 'image';
              });

              if (archiveCb && imageCb) {
                  // Pobierz basename z nazwy pliku
                  const getBasename = (filename) => {
                      const lastDotIndex = filename.lastIndexOf('.');
                      return lastDotIndex > 0 ? filename.substring(0, lastDotIndex) : filename;
                  };

                  const matchData = {
                      archiveFile: archiveCb.dataset.file,
                      archivePath: archiveCb.dataset.path.replace(/\\/g, '/'),
                      imageFile: imageCb.dataset.file,
                      imagePath: imageCb.dataset.path.replace(/\\/g, '/'),
                      archiveBasename: getBasename(archiveCb.dataset.file),
                      imageBasename: getBasename(imageCb.dataset.file),
                      timestamp: new Date().toISOString(),
                      currentFolder: getCurrentFolder()
                  };

                  console.log('üéØ Zapisujƒô dopasowanie:', matchData);

                  const matchKey = 'learningMatch_' + Date.now();
                  localStorage.setItem(matchKey, JSON.stringify(matchData));
                  localStorage.setItem('latestLearningMatch', matchKey);

                  if(matchStatus) matchStatus.textContent = '‚úÖ Zapisano! Nauka algorytmu...';
                  matchBtn.disabled = true;
                  matchBtn.textContent = '‚è≥ Przetwarzanie...';

                  // Odznacz checkboxy
                  archiveCb.checked = false;
                  imageCb.checked = false;

                  // Przywr√≥ƒá stan przycisku po 3 sekundach
                  setTimeout(() => {
                      matchBtn.disabled = false;
                      matchBtn.textContent = 'üéØ Dopasuj podglƒÖd';
                      if(matchStatus) matchStatus.textContent = '';
                  }, 3000);
              }
          });

          // Inicjalne sprawdzenie
          updateMatchButton();
        }

        // Logika dla przywracania rozmiaru kafelk√≥w z localStorage (je≈õli suwak jest w Pythonie)
        // Mo≈ºesz jƒÖ usunƒÖƒá, je≈õli rozmiar kafelk√≥w jest zarzƒÖdzany tylko przez suwak w UI Pythona
        if (typeof localStorage !== 'undefined' && localStorage.getItem('galleryTileSize')) {
            const savedSize = localStorage.getItem('galleryTileSize');
            const galleriesToResize = document.querySelectorAll('.gallery');
            galleriesToResize.forEach(gallery => {
                gallery.style.gridTemplateColumns = `repeat(auto-fill, minmax(${savedSize}px, 1fr))`;
            });
        }

        // Poni≈ºsze funkcje (showMoveFilesDialog itp.) sƒÖ definicjami,
        // ale nie sƒÖ wywo≈Çywane bezpo≈õrednio z HTML.
        // SƒÖ one dostƒôpne dla Pythona do wywo≈Çania poprzez webView.page().runJavaScript("showMoveFilesDialog();")
        // je≈õli przyciski by≈Çyby w HTML. W Twoim przypadku przyciski sƒÖ w Pythonie,
        // wiƒôc ta czƒô≈õƒá jest bardziej "bibliotekƒÖ" funkcji dla localStorage.

        let selectedFiles = []; // Zmienna globalna w tym zakresie DOMContentLoaded

        function updateSelectedFiles() {
          console.log('\n=== AKTUALIZACJA WYBRANYCH PLIK√ìW ===');
          selectedFiles = [];
          const selectedArchives = new Map(); // Map do przechowywania wybranych archiw√≥w
          const selectedImages = new Map();   // Map do przechowywania wybranych obraz√≥w

          // Najpierw zbierz wszystkie wybrane pliki
          console.log('Sprawdzam checkboxy w galerii...');
          document.querySelectorAll('.gallery-checkbox:checked').forEach(cb => {
            const type = cb.dataset.type;
            const archiveName = cb.dataset.archiveName;
            const archivePath = cb.dataset.archivePath;
            const previewName = cb.dataset.previewName;
            const previewPath = cb.dataset.previewPath;
            console.log(`Znaleziono zaznaczony plik w galerii: ${archiveName} (${type})`);

            if (type === 'archive_with_preview') {
              selectedFiles.push({
                type: type,
                archive: {
                  name: archiveName,
                  path: archivePath
                },
                preview: {
                  name: previewName,
                  path: previewPath
                }
              });
              console.log(`Dodano parƒô plik√≥w: ${archiveName} + ${previewName}`);
            }
          });

          console.log('Sprawdzam checkboxy w li≈õcie plik√≥w...');
          document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
            const type = cb.dataset.type;
            const name = cb.dataset.file;
            const path = cb.dataset.path;
            console.log(`Znaleziono zaznaczony plik w li≈õcie: ${name} (${type})`);

            if (type === 'archive') {
              selectedFiles.push({
                type: type,
                archive: {
                  name: name,
                  path: path
                }
              });
              console.log(`Dodano archiwum: ${name}`);
            } else if (type === 'image') {
              selectedFiles.push({
                type: type,
                preview: {
                  name: name,
                  path: path
                }
              });
              console.log(`Dodano obraz: ${name}`);
            }
          });

          // Teraz po≈ÇƒÖcz pliki w pary
          console.log('\n≈ÅƒÖczenie plik√≥w w pary...');
          for (const [basename, archive] of selectedArchives) {
            const image = selectedImages.get(basename);
            if (image) {
              // Je≈õli mamy parƒô, dodaj jƒÖ jako archive_with_preview
              selectedFiles.push({
                type: 'archive_with_preview',
                archive: archive,
                preview: image
              });
              selectedImages.delete(basename); // Usu≈Ñ u≈ºyty obraz
              console.log(`Utworzono parƒô: ${archive.name} + ${image.name}`);
            } else {
              // Je≈õli nie ma pary, dodaj samo archiwum
              selectedFiles.push({
                type: 'archive',
                archive: archive
              });
              console.log(`Dodano pojedyncze archiwum: ${archive.name}`);
            }
          }

          // Dodaj pozosta≈Çe obrazy, kt√≥re nie zosta≈Çy sparowane
          for (const image of selectedImages.values()) {
            selectedFiles.push({
              type: 'image',
              preview: image
            });
            console.log(`Dodano pojedynczy obraz: ${image.name}`);
          }

          console.log('\n=== PODSUMOWANIE WYBRANYCH PLIK√ìW ===');
          console.log(`≈ÅƒÖczna liczba wybranych element√≥w: ${selectedFiles.length}`);
          selectedFiles.forEach((file, index) => {
            console.log(`${index + 1}. Typ: ${file.type}`);
            if (file.type === 'archive_with_preview') {
              console.log(`   - Archiwum: ${file.archive.name}`);
              console.log(`   - PodglƒÖd: ${file.preview.name}`);
            } else if (file.type === 'archive') {
              console.log(`   - Archiwum: ${file.archive.name}`);
            } else if (file.type === 'image') {
              console.log(`   - Obraz: ${file.preview.name}`);
            }
          });
        }

        // Te funkcje zapisujƒÖ dane do localStorage, Python je odczytuje
        window.jsShowMoveFilesDialog = function() {
          console.log('\n=== ROZPOCZYNAM OPERACJƒò PRZENOSZENIA ===');
          updateSelectedFiles();
          if (selectedFiles.length === 0) {
            console.log('‚ùå Brak wybranych plik√≥w do przeniesienia');
            alert('Najpierw zaznacz pliki do przeniesienia');
            return;
          }
          const moveData = { files: selectedFiles };
          const moveKey = 'moveFiles_' + Date.now();
          console.log('Zapisujƒô dane do localStorage:');
          console.log('- Klucz:', moveKey);
          console.log('- Dane:', moveData);
          localStorage.setItem(moveKey, JSON.stringify(moveData));
          localStorage.setItem('latestMoveFiles', moveKey);
          document.querySelectorAll('.gallery-checkbox, .file-checkbox').forEach(cb => { cb.checked = false; });
          console.log('‚úÖ Operacja przenoszenia zainicjowana');
        }

        window.jsShowRenameFilesDialog = function() { // Zmieniono nazwƒô
          updateSelectedFiles();
          if (selectedFiles.length === 0) { alert('Najpierw zaznacz pliki do zmiany nazwy'); return; }
          const archiveFiles = selectedFiles.filter(f => f.type === 'archive' || f.type === 'archive_with_preview');
          const imageFiles = selectedFiles.filter(f => f.type === 'image');
          // Zamiast prompt, Python zapyta o nowƒÖ nazwƒô
          // Tutaj tylko przygotowujemy dane
          if (archiveFiles.length > 0 || imageFiles.length > 0) { // Wystarczy, ≈ºe co≈õ jest zaznaczone
              const renameData = { files: selectedFiles, /* newBaseName zostanie dodane przez Pythona */ };
              const renameKey = 'renameFiles_' + Date.now();
              localStorage.setItem(renameKey, JSON.stringify(renameData));
              localStorage.setItem('latestRenameFilesRequest', renameKey); // Inny klucz dla ≈ºƒÖdania
              document.querySelectorAll('.gallery-checkbox, .file-checkbox').forEach(cb => { cb.checked = false; });
              console.log('JS: Zapisano ≈ºƒÖdanie zmiany nazw:', renameData);
          } else {
            alert('Zaznacz pliki, aby zmieniƒá ich nazwy.');
          }
        }

        window.jsShowCreateFolderDialog = function() { // Zmieniono nazwƒô
          const folderName = prompt('Podaj nazwƒô nowego folderu:'); // JS mo≈ºe zapytaƒá, albo Python
          if (folderName && folder_name.trim()) { // U≈ºyj folder_name z prompt
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(folder_name.trim())) {
              alert(`Nazwa folderu zawiera niedozwolone znaki: ${invalidChars.source}`); return;
            }
            const createData = { parentFolder: getCurrentFolder(), folderName: folder_name.trim() };
            const createKey = 'createFolder_' + Date.now();
            localStorage.setItem(createKey, JSON.stringify(createData));
            localStorage.setItem('latestCreateFolder', createKey);
            console.log('JS: Zapisano operacjƒô tworzenia folderu:', createData);
          }
        }

        // Listener dla checkbox√≥w, aby aktualizowaƒá `selectedFiles`
        document.addEventListener('change', function (e) {
          if (e.target.matches('.gallery-checkbox, .file-checkbox')) {
            updateSelectedFiles(); // Aktualizuj przy ka≈ºdej zmianie zaznaczenia
          }
        });

        // Przycisk przenoszenia plik√≥w
        document.getElementById('moveFilesBtn').addEventListener('click', function() {
          const selectedFiles = [];

          // Najpierw zbierz wszystkie wybrane pliki
          console.log('Sprawdzam checkboxy w galerii...');
          document.querySelectorAll('.gallery-checkbox:checked').forEach(cb => {
            const type = cb.dataset.type;
            const archiveName = cb.dataset.archiveName;
            const archivePath = cb.dataset.archivePath;
            const previewName = cb.dataset.previewName;
            const previewPath = cb.dataset.previewPath;
            console.log(`Znaleziono zaznaczony plik w galerii: ${archiveName} (${type})`);

            if (type === 'archive_with_preview') {
              selectedFiles.push({
                type: type,
                archive: {
                  name: archiveName,
                  path: archivePath
                },
                preview: {
                  name: previewName,
                  path: previewPath
                }
              });
              console.log(`Dodano parƒô plik√≥w: ${archiveName} + ${previewName}`);
            }
          });

          console.log('Sprawdzam checkboxy w li≈õcie plik√≥w...');
          document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
            const type = cb.dataset.type;
            const name = cb.dataset.file;
            const path = cb.dataset.path;
            console.log(`Znaleziono zaznaczony plik w li≈õcie: ${name} (${type})`);

            if (type === 'archive') {
              selectedFiles.push({
                type: type,
                archive: {
                  name: name,
                  path: path
                }
              });
              console.log(`Dodano archiwum: ${name}`);
            } else if (type === 'image') {
              selectedFiles.push({
                type: type,
                preview: {
                  name: name,
                  path: path
                }
              });
              console.log(`Dodano obraz: ${name}`);
            }
          });

          if (selectedFiles.length === 0) {
            alert('Nie wybrano ≈ºadnych plik√≥w do przeniesienia.');
            return;
          }

          console.log('Wybrane pliki:', selectedFiles);
          window.pywebview.api.process_move_files_python_logic(selectedFiles);
        });

      });
    </script>
  </body>
</html>
