<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria: {{ current_folder_display_name }}</title>
    <link rel="stylesheet" href="{{ ' ../' * depth }}gallery_styles.css" />
  </head>
  <body>
    <div class="container">
      <!-- TYLKO BREADCRUMB - ≈õcie≈ºka -->
      <div class="breadcrumb">
        {% for part in breadcrumb_parts %} {% if part.link %}
        <a href="{{ part.link }}">{{ part.name }}</a> <span>/</span>
        {% else %}
        <span>{{ part.name }}</span>
        {% endif %} {% endfor %}
      </div>

      {% if subfolders %}
      <div class="section">
        <div class="subfolders-grid">
          {% for sf in subfolders %}
          <div
            class="subfolder-item"
            onclick="window.location.href='{{ sf.link }}'"
          >
            <div class="folder-icon" data-archive-count="{{ sf.file_count }}">
              üìÅ
            </div>
            <a href="{{ sf.link }}">{{ sf.name }}</a>
            <div class="folder-stats">
              <span
                >{{ sf.total_size_readable }} | {{ sf.file_count }} plik√≥w{% if
                sf.subdir_count > 0 %} | {{ sf.subdir_count }} folder√≥w{% endif
                %}</span
              >
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %} {% if files_with_previews %}
      <div class="section">
        <h2>üñºÔ∏è Pliki z podglƒÖdem ({{ files_with_previews|length }})</h2>
        <div class="gallery" id="filesWithPreviewsGallery">
          {% for file in files_with_previews %}
          <div
            class="gallery-item"
            style="background-color: {{ file.archive_color }}22; border-color: {{ file.archive_color }};"
          >
            <!-- Checkbox w lewym g√≥rnym rogu -->
            <input
              type="checkbox"
              class="gallery-checkbox"
              data-file="{{ file.name }}"
              data-path="{{ file.path_absolute }}"
            />

            {% if file.preview_relative_path %}
            <img
              src="{{ file.preview_relative_path }}"
              alt="PodglƒÖd dla {{ file.name }}"
              class="preview-image"
              data-full-src="{{ file.preview_relative_path }}"
            />
            {% else %}
            <div
              style="
                height: 160px;
                background: var(--bg-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                color: var(--text-secondary);
              "
            >
              <span>Brak podglƒÖdu</span>
            </div>
            {% endif %}
            <p>
              <a href="{{ file.archive_link }}" title="Otw√≥rz: {{ file.name }}"
                >{{ file.name }}</a
              >
            </p>
            <p class="file-info">{{ file.size_readable }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- DWIE KOLUMNY NA DOLE - PLIKI BEZ PODGLƒÑDU I POZOSTA≈ÅE OBRAZY -->
      {% if files_without_previews or other_images %}
      <div class="bottom-columns">
        {% if files_without_previews %}
        <div class="left-column">
          <h2>üìÑ Pliki bez podglƒÖdu ({{ files_without_previews|length }})</h2>
          <ul class="no-preview-list">
            {% for file in files_without_previews %}
            <li style="border-left: 4px solid {{ file.archive_color }};">
              <div class="file-item">
                <input
                  type="checkbox"
                  class="file-checkbox"
                  data-file="{{ file.name }}"
                  data-path="{{ file.path_absolute }}"
                  data-basename="{{ file.name.split('.')[0] }}"
                  data-type="archive"
                />
                <a
                  href="{{ file.archive_link }}"
                  title="Otw√≥rz: {{ file.name }}"
                  >{{ file.name }}</a
                >
                <span class="file-info"> ‚Äî {{ file.size_readable }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %} {% if other_images %}
        <div class="right-column">
          <h2>üé® Pozosta≈Çe obrazy ({{ other_images|length }})</h2>
          <ul class="image-list">
            {% for image in other_images %}
            <li>
              <div class="file-item">
                <input
                  type="checkbox"
                  class="file-checkbox"
                  data-file="{{ image.name }}"
                  data-path="{{ image.path_absolute }}"
                  data-basename="{{ image.name.split('.')[0] }}"
                  data-type="image"
                />
                <a
                  href="{{ image.file_link }}"
                  title="Otw√≥rz: {{ image.name }}"
                  data-preview-src="{{ image.image_relative_path }}"
                  class="preview-link"
                  >{{ image.name }}</a
                >
                <span class="file-info"> ‚Äî {{ image.size_readable }}</span>
                <!-- IKONKA KOSZA DO USUWANIA -->
                <button
                  class="delete-image-btn"
                  data-file-path="{{ image.path_absolute }}"
                  data-file-name="{{ image.name }}"
                  title="Usu≈Ñ {{ image.name }} do kosza"
                >
                  üóëÔ∏è
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- PRZYCISK DOPASUJ PODGLƒÑD -->
      {% if files_without_previews and other_images %}
      <div class="learning-section">
        <button id="matchPreviewBtn" class="match-preview-btn" disabled>
          üéØ Dopasuj podglƒÖd
        </button>
        <div id="matchStatus" class="match-status"></div>
      </div>
      {% endif %}
    </div>

    <!-- Modal podglƒÖdu -->
    <div class="preview-backdrop" id="previewBackdrop"></div>
    <div class="preview-modal" id="previewModal">
      <img src="" alt="PodglƒÖd" id="previewImg" />
    </div>

    <script>
      // Globalne funkcje
      function getCurrentFolder() {
        // Pobierz aktualny folder z URL galerii
        const currentUrl = window.location.pathname;
        if (currentUrl.includes('_gallery_cache')) {
          // Konwertuj ≈õcie≈ºkƒô galerii na rzeczywistƒÖ ≈õcie≈ºkƒô
          const parts = currentUrl.split('_gallery_cache/')[1];
          if (parts) {
            const galleryPath = parts.replace('/index.html', '');
            // Zwr√≥ƒá rzeczywistƒÖ ≈õcie≈ºkƒô folderu
            return '{{ folder_info.path if folder_info else "." }}';
          }
        }
        // Je≈õli nie jeste≈õmy w galerii, zwr√≥ƒá ≈õcie≈ºkƒô z folder_info
        return '{{ folder_info.path if folder_info else "." }}';
      }

      // Dodaj do window dla pewno≈õci
      window.getCurrentFolder = getCurrentFolder;

      document.addEventListener('DOMContentLoaded', function () {
        const galleries = [
          document.getElementById('filesWithPreviewsGallery'),
        ].filter(Boolean);

        const previewModal = document.getElementById('previewModal');
        const previewBackdrop = document.getElementById('previewBackdrop');
        const previewImg = document.getElementById('previewImg');
        const matchBtn = document.getElementById('matchPreviewBtn');
        const matchStatus = document.getElementById('matchStatus');

        // PodglƒÖd w modalnym oknie
        function showPreview(imageSrc) {
          if (!imageSrc) return;
          previewImg.src = imageSrc;
          previewModal.classList.add('show');
          previewBackdrop.classList.add('show');
          previewModal.style.transform = 'translate(-50%, -50)';
        }

        function hidePreview() {
          previewModal.classList.remove('show');
          previewBackdrop.classList.remove('show');
          previewImg.src = '';
        }

        // OBS≈ÅUGA USUWANIA PLIK√ìW OBRAZ√ìW
        const deleteButtons = document.querySelectorAll('.delete-image-btn');
        deleteButtons.forEach((button) => {
          button.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const filePath = this.dataset.filePath;
            const fileName = this.dataset.fileName;

            if (
              confirm(`Czy na pewno chcesz usunƒÖƒá plik "${fileName}" do kosza?`)
            ) {
              try {
                // Sprawd≈∫ dostƒôpno≈õƒá localStorage
                if (typeof Storage === 'undefined' || !localStorage) {
                  alert('Funkcja usuwania nie jest dostƒôpna w tym kontek≈õcie');
                  return;
                }

                // Komunikacja z PyQt przez localStorage
                const deleteData = {
                  action: 'deleteFile',
                  filePath: filePath,
                  fileName: fileName,
                  timestamp: new Date().toISOString(),
                };

                console.log('üóëÔ∏è Usuwanie pliku:', deleteData);

                // Zapisz do localStorage
                const deleteKey = 'deleteFile_' + Date.now();
                localStorage.setItem(deleteKey, JSON.stringify(deleteData));
                localStorage.setItem('latestDelete', deleteKey);

                // Wy≈ÇƒÖcz przycisk i poka≈º status
                this.textContent = '‚è≥';
                this.disabled = true;
                this.style.opacity = '0.5';

                // Poka≈º komunikat o przetwarzaniu
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = `
                  position: fixed; top: 20px; right: 20px; z-index: 9999;
                  background: var(--warning); color: white; padding: 12px 20px;
                  border-radius: 8px; font-weight: 500; box-shadow: var(--shadow);
                `;
                statusDiv.textContent = `‚è≥ Usuwanie "${fileName}"...`;
                document.body.appendChild(statusDiv);

                // Usu≈Ñ komunikat po 5 sekundach
                setTimeout(() => {
                  if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                  }
                }, 5000);
              } catch (e) {
                console.error('B≈ÇƒÖd usuwania pliku:', e);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania pliku');
              }
            }
          });
        });

        // PodglƒÖd na hover dla obraz√≥w
        galleries.forEach((gallery) => {
          const images = gallery.querySelectorAll('.preview-image');
          images.forEach((img) => {
            let hoverTimeout;

            img.addEventListener('mouseenter', function () {
              hoverTimeout = setTimeout(() => {
                showPreview(this.src);
              }, 2000);
            });

            img.addEventListener('mouseleave', function () {
              clearTimeout(hoverTimeout);
            });
          });
        });

        // PodglƒÖd na hover dla link√≥w w right-column
        const previewLinks = document.querySelectorAll('.preview-link');
        previewLinks.forEach((link) => {
          let hoverTimeout;

          link.addEventListener('mouseenter', function () {
            const previewSrc = this.getAttribute('data-preview-src');
            if (previewSrc) {
              hoverTimeout = setTimeout(() => {
                showPreview(previewSrc);
              }, 2000);
            }
          });

          link.addEventListener('mouseleave', function () {
            clearTimeout(hoverTimeout);
          });
        });

        // Zamykanie modala
        previewBackdrop.addEventListener('click', hidePreview);
        previewModal.addEventListener('click', hidePreview);

        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            hidePreview();
          }
        });

        // FUNKCJONALNO≈öƒÜ UCZENIA SIƒò ALGORYTMU
        if (matchBtn) {
          // Sprawd≈∫ dostƒôpno≈õƒá localStorage
          let localStorageAvailable = false;
          try {
            if (typeof Storage !== 'undefined' && localStorage) {
              localStorage.setItem('test', 'test');
              localStorage.removeItem('test');
              localStorageAvailable = true;
            }
          } catch (e) {
            console.warn('localStorage nie jest dostƒôpny:', e);
          }

          if (!localStorageAvailable) {
            matchBtn.style.display = 'none';
            matchStatus.textContent =
              '‚ö†Ô∏è Funkcje uczenia siƒô sƒÖ niedostƒôpne w tym kontek≈õcie';
            return;
          }

          const checkboxes = document.querySelectorAll('.file-checkbox');

          function updateMatchButton() {
            const archiveChecked = Array.from(checkboxes).filter(
              (cb) => cb.checked && cb.dataset.type === 'archive'
            );
            const imageChecked = Array.from(checkboxes).filter(
              (cb) => cb.checked && cb.dataset.type === 'image'
            );

            // Aktywuj przycisk gdy dok≈Çadnie 1 archiwum i 1 obraz jest zaznaczony
            matchBtn.disabled = !(
              archiveChecked.length === 1 && imageChecked.length === 1
            );

            if (matchBtn.disabled) {
              matchStatus.textContent = '';
            } else {
              matchStatus.textContent = `Gotowy do dopasowania: ${archiveChecked[0].dataset.file} ‚Üî ${imageChecked[0].dataset.file}`;
            }
          }

          // Nas≈Çuchuj zmian w checkboxach
          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', function () {
              // Je≈õli zaznaczono checkbox, odznacz inne w tej samej kategorii
              if (this.checked) {
                checkboxes.forEach((otherCheckbox) => {
                  if (
                    otherCheckbox !== this &&
                    otherCheckbox.dataset.type === this.dataset.type
                  ) {
                    otherCheckbox.checked = false;
                  }
                });
              }
              updateMatchButton();
            });
          });

          // Obs≈Çuga klikniƒôcia przycisku dopasowania
          matchBtn.addEventListener('click', function () {
            const archiveChecked = Array.from(checkboxes).find(
              (cb) => cb.checked && cb.dataset.type === 'archive'
            );
            const imageChecked = Array.from(checkboxes).find(
              (cb) => cb.checked && cb.dataset.type === 'image'
            );

            if (archiveChecked && imageChecked) {
              // BEZPO≈öREDNIA KOMUNIKACJA Z PyQt przez localStorage
              const matchData = {
                archiveFile: archiveChecked.dataset.file,
                archivePath: archiveChecked.dataset.path.replace(/\\/g, '/'),
                imageFile: imageChecked.dataset.file,
                imagePath: imageChecked.dataset.path.replace(/\\/g, '/'),
                archiveBasename: archiveChecked.dataset.basename,
                imageBasename: imageChecked.dataset.basename,
                timestamp: new Date().toISOString(),
                currentFolder: window.location.pathname,
              };

              console.log('üéØ Zapisujƒô dopasowanie:', matchData);

              // ZAPISZ DO localStorage z unikalnym kluczem
              const matchKey = 'learningMatch_' + Date.now();
              localStorage.setItem(matchKey, JSON.stringify(matchData));
              localStorage.setItem('latestMatch', matchKey);

              // Informuj o powodzeniu
              matchStatus.textContent =
                '‚úÖ Dopasowanie zapisane! Trwa nauka algorytmu...';
              matchBtn.disabled = true;
              matchBtn.textContent = '‚è≥ Przetwarzanie...';

              // Wyczy≈õƒá checkboxy
              archiveChecked.checked = false;
              imageChecked.checked = false;

              // Wywo≈Çaj polling PyQt natychmiast
              setTimeout(() => {
                window.dispatchEvent(
                  new CustomEvent('learningMatchReady', {
                    detail: matchData,
                  })
                );
              }, 100);
            }
          });
        }

        // OPERACJE NA PLIKACH
        let selectedFiles = [];

        function updateSelectedFiles() {
          selectedFiles = [];

          // Zbierz zaznaczone pliki z galerii
          document
            .querySelectorAll('.gallery-checkbox:checked')
            .forEach((cb) => {
              selectedFiles.push({
                type: 'archive_with_preview',
                name: cb.dataset.file,
                path: cb.dataset.path,
                preview:
                  cb.closest('.gallery-item').querySelector('img')?.src || null,
              });
            });

          // Zbierz zaznaczone pliki bez podglƒÖdu
          document
            .querySelectorAll('.file-checkbox:checked[data-type="archive"]')
            .forEach((cb) => {
              selectedFiles.push({
                type: 'archive',
                name: cb.dataset.file,
                path: cb.dataset.path,
                basename: cb.dataset.basename,
              });
            });

          // Zbierz zaznaczone obrazy
          document
            .querySelectorAll('.file-checkbox:checked[data-type="image"]')
            .forEach((cb) => {
              selectedFiles.push({
                type: 'image',
                name: cb.dataset.file,
                path: cb.dataset.path,
                basename: cb.dataset.basename,
              });
            });

          console.log('Wybrane pliki:', selectedFiles);
        }

        function showMoveFilesDialog() {
          updateSelectedFiles();

          if (selectedFiles.length === 0) {
            alert('Najpierw zaznacz pliki do przeniesienia');
            return;
          }

          const moveData = {
            files: selectedFiles,
          };

          const moveKey = 'moveFiles_' + Date.now();
          localStorage.setItem(moveKey, JSON.stringify(moveData));
          localStorage.setItem('latestMoveFiles', moveKey);

          // Odznacz wszystkie checkboxy
          document
            .querySelectorAll('.gallery-checkbox, .file-checkbox')
            .forEach((cb) => {
              cb.checked = false;
            });

          console.log('Zapisano operacjƒô przenoszenia:', moveData);
        }

        function showRenameFilesDialog() {
          updateSelectedFiles();

          if (selectedFiles.length === 0) {
            alert('Najpierw zaznacz pliki do zmiany nazwy');
            return;
          }

          // Sprawd≈∫ czy zaznaczone pliki mogƒÖ byƒá zmieniane razem
          const archiveFiles = selectedFiles.filter(
            (f) => f.type === 'archive' || f.type === 'archive_with_preview'
          );
          const imageFiles = selectedFiles.filter((f) => f.type === 'image');

          if (archiveFiles.length > 0 && imageFiles.length > 0) {
            // Je≈õli sƒÖ archiwum i obraz, zaproponuj wsp√≥lnƒÖ nazwƒô
            const newBaseName = prompt(
              'Podaj nowƒÖ wsp√≥lnƒÖ nazwƒô bazowƒÖ (bez rozszerzenia):'
            );
            if (newBaseName && newBaseName.trim()) {
              const renameData = {
                files: selectedFiles,
                newBaseName: newBaseName.trim(),
              };

              const renameKey = 'renameFiles_' + Date.now();
              localStorage.setItem(renameKey, JSON.stringify(renameData));
              localStorage.setItem('latestRenameFiles', renameKey);

              // Odznacz wszystkie checkboxy
              document
                .querySelectorAll('.gallery-checkbox, .file-checkbox')
                .forEach((cb) => {
                  cb.checked = false;
                });

              console.log('Zapisano operacjƒô zmiany nazw:', renameData);
            }
          } else {
            alert('Zaznacz archiwum i odpowiadajƒÖcy mu obraz do zmiany nazwy');
          }
        }

        function showCreateFolderDialog() {
          const folderName = prompt('Podaj nazwƒô nowego folderu:');
          if (folderName && folderName.trim()) {
            // Walidacja nazwy folderu
            const invalidChars = '<>:"/\\|?*';
            if (
              invalidChars.split('').some((char) => folderName.includes(char))
            ) {
              alert(
                `Nazwa folderu zawiera niedozwolone znaki: ${invalidChars}`
              );
              return;
            }

            const createData = {
              parentFolder: getCurrentFolder(),
              folderName: folderName.trim(),
            };

            const createKey = 'createFolder_' + Date.now();
            localStorage.setItem(createKey, JSON.stringify(createData));
            localStorage.setItem('latestCreateFolder', createKey);

            console.log('Zapisano operacjƒô tworzenia folderu:', createData);
          }
        }

        // Obs≈Çuga checkbox√≥w - aktualizuj stan przy zmianie
        document.addEventListener('change', function (e) {
          if (e.target.matches('.gallery-checkbox, .file-checkbox')) {
            updateSelectedFiles();
          }
        });
      });
    </script>
  </body>
</html>
