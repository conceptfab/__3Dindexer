<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Galeria: {{ current_folder_display_name }}</title>
    <link rel="stylesheet" href="{{ ' ../' * depth }}gallery_styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="breadcrumb">
        {% for part in breadcrumb_parts %} {% if part.link %}
        <a href="{{ part.link }}">{{ part.name }}</a> / {% else %}
        <span>{{ part.name }}</span>
        {% endif %} {% endfor %}
      </div>
      <h1>Galeria: {{ current_folder_display_name }}</h1>
      <p>Pełna ścieżka: {{ folder_info.path }}</p>

      <div class="gallery-controls">
        <label for="sizeSlider">Rozmiar miniaturki:</label>
        <input type="range" id="sizeSlider" min="100" max="400" value="150" />
        <span id="sizeValue">150px</span>
      </div>

      {% if subfolders %}
      <div class="section">
        <h2>Podfoldery ({{ subfolders|length }})</h2>
        <div class="subfolders-grid">
          {% for sf in subfolders %}
          <div class="subfolder-item">
            <a href="{{ sf.link }}">📁 {{ sf.name }}</a>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %} {% if files_with_previews %}
      <div class="section">
        <h2>Pliki z podglądem ({{ files_with_previews|length }})</h2>
        <div class="gallery" id="filesWithPreviewsGallery">
          {% for file in files_with_previews %}
          <div class="gallery-item">
            <a
              href="{{ file.archive_link }}"
              title="Otwórz plik: {{ file.name }}"
            >
              {% if file.preview_relative_path %}
              <img
                src="{{ file.preview_relative_path }}"
                alt="Podgląd dla {{ file.name }}"
                class="preview-image"
              />
              {% else %}
              <div
                style="
                  height: 140px;
                  background: var(--bg-primary);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <span>Brak podglądu</span>
              </div>
              {% endif %}
            </a>
            <p>
              <a
                href="{{ file.archive_link }}"
                title="Otwórz plik: {{ file.name }}"
                >{{ file.name }}</a
              >
            </p>
            <p class="file-info">{{ file.size_readable }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %} {% if other_images %}
      <div class="section">
        <h2>Pozostałe obrazy ({{ other_images|length }})</h2>
        <div class="gallery" id="otherImagesGallery">
          {% for image in other_images %}
          <div class="gallery-item">
            <a
              href="{{ image.file_link }}"
              title="Otwórz plik: {{ image.name }}"
            >
              {% if image.image_relative_path %}
              <img
                src="{{ image.image_relative_path }}"
                alt="{{ image.name }}"
                class="preview-image"
              />
              {% else %}
              <div
                style="
                  height: 140px;
                  background: var(--bg-primary);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 8px;
                "
              >
                <span>Błąd ładowania</span>
              </div>
              {% endif %}
            </a>
            <p>
              <a
                href="{{ image.file_link }}"
                title="Otwórz plik: {{ image.name }}"
                >{{ image.name }}</a
              >
            </p>
            <p class="file-info">{{ image.size_readable }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %} {% if files_without_previews %}
      <div class="section">
        <h2>Pliki bez podglądu ({{ files_without_previews|length }})</h2>
        <ul class="no-preview-list">
          {% for file in files_without_previews %}
          <li>
            <a
              href="{{ file.archive_link }}"
              title="Otwórz plik: {{ file.name }}"
              >{{ file.name }}</a
            >
            <span class="file-info"> ({{ file.size_readable }})</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="section folder-stats">
        <h3>Statystyki folderu</h3>
        <p>Całkowity rozmiar plików: {{ folder_info.total_size_readable }}</p>
        <p>Liczba plików: {{ folder_info.file_count }}</p>
        <p>Liczba podfolderów: {{ folder_info.subdir_count }}</p>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const slider = document.getElementById('sizeSlider');
        const sizeValueDisplay = document.getElementById('sizeValue');
        const galleries = [
          document.getElementById('filesWithPreviewsGallery'),
          document.getElementById('otherImagesGallery'),
        ].filter(Boolean);

        // Tworzenie overlay'a dla podglądu
        const previewOverlay = document.createElement('div');
        previewOverlay.className = 'preview-overlay';
        previewOverlay.innerHTML = '<img src="" alt="Podgląd">';
        document.body.appendChild(previewOverlay);

        function updateThumbnailSize() {
          const newSize = slider.value + 'px';
          sizeValueDisplay.textContent = newSize;
          galleries.forEach((gallery) => {
            const items = gallery.querySelectorAll('.gallery-item');
            items.forEach((item) => {
              item.style.width = newSize;
              const img = item.querySelector('img');
              if (img) {
                img.style.maxHeight = parseInt(slider.value) * 0.8 + 'px';
              }
            });
          });
        }

        function showPreview(imageSrc, event) {
          event.preventDefault();
          event.stopPropagation();

          const previewImg = previewOverlay.querySelector('img');
          previewImg.src = imageSrc;
          previewImg.style.maxWidth = '800px';
          previewImg.style.maxHeight = '800px';

          previewOverlay.classList.add('show');
        }

        function hidePreview() {
          previewOverlay.classList.remove('show');
        }

        // Event listenery
        if (slider) {
          slider.addEventListener('input', updateThumbnailSize);
          updateThumbnailSize();
        }

        // Podgląd na hover dla miniaturek
        galleries.forEach((gallery) => {
          const images = gallery.querySelectorAll('.preview-image');
          images.forEach((img) => {
            let hoverTimeout;

            img.addEventListener('mouseenter', function (e) {
              hoverTimeout = setTimeout(() => {
                showPreview(this.src, e);
              }, 300); // Opóźnienie 300ms
            });

            img.addEventListener('mouseleave', function () {
              clearTimeout(hoverTimeout);
              setTimeout(hidePreview, 100);
            });
          });
        });

        // Ukryj podgląd po kliknięciu lub ESC
        previewOverlay.addEventListener('click', hidePreview);
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape') {
            hidePreview();
          }
        });

        // Hover na overlay też ukrywa
        previewOverlay.addEventListener('mouseenter', function () {
          setTimeout(hidePreview, 500);
        });
      });
    </script>
  </body>
</html>
